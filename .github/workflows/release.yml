name: Release
on:
  push:
    tags:
      - '**'
    branches:
      - master

jobs:
  push-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Build Docker image
        run: make docker-images
      - name: Push to Dockerhub
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          function tag_and_push {
            docker tag tempo:latest "annanay25/tempo:${1}" && docker push "annanay25/tempo:${1}"
            docker tag tempo-query:latest "annanay25/tempo-query:${1}" && docker push "annanay25/tempo-query:${1}"
            docker tag tempo-vulture:latest "annanay25/tempo-vulture:${1}" && docker push "annanay25/tempo-vulture:${1}"
          }
          if [[ "${GITHUB_REF}" == "refs/heads/master" ]]; then
            tag_and_push "latest"
            git_hash=$(git rev-parse --short "$GITHUB_SHA")
            tag_and_push "$git_hash"
          elif [[ "${GITHUB_REF}" =~ refs/tags/v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              TAG="${GITHUB_REF#"refs/tags/v"}"
              tag_and_push "${TAG}"
              tag_and_push "latest"
          else
            tag_and_push "${GITHUB_REF#"refs/tags/"}"
          fi
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          make release
      - name: Upload release artifacts
        uses: actions/upload-artifact@v2
        with:
          name: release-artifacts
          path: |
            dist/
            !dist/*/*